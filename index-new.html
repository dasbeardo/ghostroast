<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>Roast Mortem</title>

  <!-- Favicon (placeholder) -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’€</text></svg>">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Creepster&family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css">

  <style>
    /* Loading screen */
    .loading-screen {
      position: fixed;
      inset: 0;
      background: var(--color-bg-dark);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }

    .loading-screen.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    .loading-logo {
      font-family: 'Creepster', cursive;
      font-size: 36px;
      color: #7ec850;
      text-align: center;
      line-height: 1.1;
      text-shadow:
        2px 2px 0 #8b0000,
        4px 4px 0 #0f0f1a;
      margin-bottom: 24px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(126, 200, 80, 0.2);
      border-top-color: #7ec850;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* API Key Screen */
    .api-key-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 32px;
      text-align: center;
    }

    .api-key-screen .logo {
      font-family: 'Creepster', cursive;
      font-size: 42px;
      color: #7ec850;
      line-height: 1.1;
      text-shadow:
        3px 3px 0 #8b0000,
        6px 6px 0 #0f0f1a;
      margin-bottom: 32px;
    }

    .api-key-screen p {
      color: #a0a0a0;
      font-size: 14px;
      margin-bottom: 16px;
      max-width: 280px;
    }

    .api-key-screen input {
      width: 100%;
      max-width: 300px;
      padding: 16px;
      background: #16213e;
      border: 2px solid #7ec850;
      border-radius: 8px;
      color: #f0e6d3;
      font-family: 'Courier Prime', monospace;
      font-size: 14px;
      margin-bottom: 16px;
    }

    .api-key-screen input::placeholder {
      color: #a0a0a0;
    }

    .api-key-screen input:focus {
      outline: none;
      box-shadow: 0 0 20px rgba(126, 200, 80, 0.3);
    }

    .api-key-screen .help-link {
      color: #a0a0a0;
      font-size: 12px;
      text-decoration: underline;
      cursor: pointer;
      margin-top: 16px;
    }

    .api-key-screen .help-link:hover {
      color: #7ec850;
    }

    /* Player name screen */
    .player-name-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 32px;
      text-align: center;
    }

    .player-name-screen h2 {
      font-family: 'Press Start 2P', monospace;
      font-size: 14px;
      color: #7ec850;
      margin-bottom: 8px;
    }

    .player-name-screen p {
      color: #a0a0a0;
      font-size: 14px;
      margin-bottom: 24px;
    }

    .player-name-screen input {
      width: 100%;
      max-width: 280px;
      padding: 16px;
      background: #16213e;
      border: 2px solid #e9a820;
      border-radius: 8px;
      color: #f0e6d3;
      font-family: 'Press Start 2P', monospace;
      font-size: 12px;
      text-align: center;
      margin-bottom: 24px;
    }

    .player-name-screen input:focus {
      outline: none;
      box-shadow: 0 0 20px rgba(233, 168, 32, 0.3);
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loading">
    <div class="loading-logo">ROAST<br>MORTEM</div>
    <div class="loading-spinner"></div>
  </div>

  <!-- Game Container -->
  <div class="game-container" id="game">
    <!-- Screens render here -->
  </div>

  <!-- Module Script -->
  <script type="module">
    // Show error on screen (since we can't see console)
    function showError(msg) {
      const loading = document.getElementById('loading');
      if (loading) {
        loading.innerHTML = `<div style="color: #ff6b6b; padding: 20px; font-family: monospace; font-size: 12px; text-align: left; max-width: 90%; word-break: break-word;">
          <strong style="color: #7ec850;">Error loading modules:</strong><br><br>${msg}
        </div>`;
      }
    }

    // Wrap imports in try-catch
    let state, VERSION, GameController, el, $;

    try {
      const stateModule = await import('./js/state.js');
      state = stateModule.state;
      VERSION = stateModule.VERSION;
    } catch (e) {
      showError(`state.js: ${e.message}`);
      throw e;
    }

    try {
      const controllerModule = await import('./js/ui/GameController.js');
      GameController = controllerModule.GameController;
    } catch (e) {
      showError(`GameController.js: ${e.message}`);
      throw e;
    }

    try {
      const domModule = await import('./js/ui/dom.js');
      el = domModule.el;
      $ = domModule.$;
    } catch (e) {
      showError(`dom.js: ${e.message}`);
      throw e;
    }

    // Check for API key in URL hash
    function checkUrlHash() {
      if (window.location.hash && window.location.hash.length > 1) {
        const hashKey = window.location.hash.substring(1);
        if (hashKey.startsWith('sk-')) {
          localStorage.setItem('roastmortem_apikey', hashKey);
          state.apiKey = hashKey;
          // Clear hash from URL
          history.replaceState(null, '', window.location.pathname);
        }
      }
    }

    // Show API key entry screen
    function showApiKeyScreen() {
      const game = $('#game');
      game.innerHTML = '';

      const screen = el('div', { class: 'api-key-screen' }, [
        el('div', { class: 'logo' }, ['ROAST', el('br'), 'MORTEM']),
        el('p', {}, ['Enter your OpenAI API key to begin.']),
        el('input', {
          type: 'password',
          id: 'api-key-input',
          placeholder: 'sk-...',
          autocomplete: 'off'
        }),
        el('button', {
          class: 'btn btn--primary btn--full',
          onClick: () => {
            const key = $('#api-key-input').value.trim();
            if (key) {
              localStorage.setItem('roastmortem_apikey', key);
              state.apiKey = key;
              checkPlayerName();
            }
          }
        }, ['Continue']),
        el('span', { class: 'help-link' }, ["What's this?"])
      ]);

      game.appendChild(screen);

      // Focus input
      setTimeout(() => $('#api-key-input')?.focus(), 100);
    }

    // Show player name entry screen
    function showPlayerNameScreen() {
      const game = $('#game');
      game.innerHTML = '';

      const screen = el('div', { class: 'player-name-screen' }, [
        el('h2', {}, ['What\'s Your Stage Name?']),
        el('p', {}, ['The spirits need to know who you are.']),
        el('input', {
          type: 'text',
          id: 'player-name-input',
          placeholder: 'Enter name...',
          maxlength: '20',
          autocomplete: 'off'
        }),
        el('button', {
          class: 'btn btn--primary btn--full',
          onClick: () => {
            const name = $('#player-name-input').value.trim();
            if (name) {
              state.playerName = name;
              if (!state.stats) state.stats = {};
              state.stats.playerName = name;
              localStorage.setItem('roastmortem_stats', JSON.stringify(state.stats));
              startGame();
            }
          }
        }, ['Enter the Void'])
      ]);

      game.appendChild(screen);

      // Focus input
      setTimeout(() => $('#player-name-input')?.focus(), 100);
    }

    // Check if player has a name
    function checkPlayerName() {
      if (state.playerName) {
        startGame();
      } else {
        showPlayerNameScreen();
      }
    }

    // Start the game
    function startGame() {
      const controller = new GameController('#game');
      controller.init();
    }

    // Initialize
    async function init() {
      checkUrlHash();

      // Hide loading screen
      setTimeout(() => {
        $('#loading').classList.add('fade-out');
        setTimeout(() => {
          $('#loading').style.display = 'none';
        }, 300);
      }, 500);

      // Check auth state
      if (!state.apiKey) {
        showApiKeyScreen();
      } else {
        checkPlayerName();
      }
    }

    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
